ARG version=28.1
ARG datadir=/home/bitcoin/.bitcoin

FROM debian:bookworm-slim AS base
ARG version
ENV BITCOIN_VERSION=$version

RUN apt update \
  && apt upgrade \
  && apt install -y wget

WORKDIR /opt
RUN wget https://bitcoincore.org/bin/bitcoin-core-${BITCOIN_VERSION}/bitcoin-${BITCOIN_VERSION}-x86_64-linux-gnu.tar.gz
RUN tar xvf bitcoin-${BITCOIN_VERSION}-x86_64-linux-gnu.tar.gz

# Second stage
FROM debian:bookworm-slim AS final
ARG version
ARG datadir
ARG UID=1000
ARG GID=1000

ENV BITCOIN_VERSION=$version

ENV BITCOIN_DATA=$datadir
ENV PATH=/opt/bitcoin-${BITCOIN_VERSION}/bin:$PATH

RUN groupadd --gid ${GID} bitcoin \
  && useradd --create-home --no-log-init -u ${UID} -g ${GID} bitcoin \
  && apt-get update -y \
  && apt-get clean \
  && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

RUN mkdir -p /home/bitcoin/.bitcoin
RUN chown bitcoin:bitcoin /home/bitcoin/.bitcoin

COPY --from=base /opt/bitcoin-${BITCOIN_VERSION} /opt/bitcoin-${BITCOIN_VERSION}

VOLUME ["/home/bitcoin/.bitcoin"]
EXPOSE 8332 8333 18332 18333 18443 18444 38333 38332

USER bitcoin
CMD bitcoind -datadir=${BITCOIN_DATA}
